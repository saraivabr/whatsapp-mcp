version: '3.8'

# ==============================================
# WhatsApp MCP Web Interface
# Complete Docker Compose Configuration
# ==============================================

services:
  # ==============================================
  # WhatsApp Bridge (Go)
  # Handles WhatsApp connection and messaging
  # ==============================================
  whatsapp-bridge:
    build:
      context: ./whatsapp-bridge
      dockerfile: Dockerfile
      args:
        - CGO_ENABLED=1
    image: whatsapp-mcp/bridge:latest
    container_name: whatsapp-bridge
    hostname: whatsapp-bridge

    # Ports
    ports:
      - "8080:8080"  # REST API & WebSocket

    # Volumes for persistent data
    volumes:
      - whatsapp-data:/app/store:rw
      - type: bind
        source: ./whatsapp-bridge/store
        target: /app/store

    # Environment variables
    environment:
      - TZ=America/Sao_Paulo

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Restart policy
    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/connection-status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Networks
    networks:
      - whatsapp-network

  # ==============================================
  # Backend Web Server (Python FastAPI)
  # Orchestrates Claude AI and MCP communication
  # ==============================================
  backend:
    build:
      context: ./whatsapp-web-backend
      dockerfile: Dockerfile
    image: whatsapp-mcp/backend:latest
    container_name: whatsapp-backend
    hostname: whatsapp-backend

    # Ports
    ports:
      - "8000:8000"  # FastAPI server

    # Environment variables
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:?Error: ANTHROPIC_API_KEY not set}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-sonnet-4-20250514}
      - WHATSAPP_BRIDGE_URL=http://whatsapp-bridge:8080
      - WHATSAPP_BRIDGE_WS_URL=ws://whatsapp-bridge:8080
      - MCP_SERVER_CWD=/app/../whatsapp-mcp-server
      - TZ=America/Sao_Paulo

    # Volumes - Mount MCP server
    volumes:
      - ./whatsapp-mcp-server:/app/whatsapp-mcp-server:ro
      - ./whatsapp-bridge/store:/app/store:ro  # Read-only access to WhatsApp data

    # Dependencies with health checks
    depends_on:
      whatsapp-bridge:
        condition: service_healthy

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Restart policy
    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Networks
    networks:
      - whatsapp-network

  # ==============================================
  # Frontend (Next.js)
  # Web interface for users
  # ==============================================
  frontend:
    build:
      context: ./whatsapp-web-ui
      dockerfile: Dockerfile
    image: whatsapp-mcp/frontend:latest
    container_name: whatsapp-frontend
    hostname: whatsapp-frontend

    # Ports
    ports:
      - "3000:3000"  # Next.js server

    # Environment variables
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
      - NODE_ENV=production
      - TZ=America/Sao_Paulo

    # Dependencies with health checks
    depends_on:
      backend:
        condition: service_healthy
      whatsapp-bridge:
        condition: service_healthy

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    # Restart policy
    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Networks
    networks:
      - whatsapp-network

# ==============================================
# Networks
# ==============================================
networks:
  whatsapp-network:
    driver: bridge
    name: whatsapp-mcp-network
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

# ==============================================
# Volumes
# ==============================================
volumes:
  whatsapp-data:
    name: whatsapp-mcp-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./whatsapp-bridge/store
